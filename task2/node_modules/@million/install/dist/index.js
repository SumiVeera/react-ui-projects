"use strict";var e=require("@clack/prompts"),n=require("tty"),i=require("posthog-node"),t=require("fs"),o=require("child_process"),l=require("util"),r=require("diff"),a=require("@axiomhq/js"),s=require("path"),c=require("process"),u=require("fs/promises"),f=require("@antfu/ni"),p=require("@babel/core"),d=require("@babel/types");function m(e){return e&&e.__esModule?e:{default:e}}function g(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var t=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(n,i,t.get?t:{enumerable:!0,get:function(){return e[i]}})}})),n.default=e,Object.freeze(n)}var b,y=g(e),w=g(t),h=m(l),v=g(r),x=m(s),k=m(c),C=m(u),j=g(d),F={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgGray:[100,49],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49],blackStylize:["#121212","#eeeeee18"],redStylize:["#cb7676","#ab5959"],greenStylize:["#4d9375","#1e754f"],yellowStylize:["#f6c177","#f6c17790"],blueStylize:["#6394bf","#296aa3"],magentaStylize:["#c391e6","#c391e690"],pinkStylize:["#ed9cc2","#ed9cc290"],cyanStylize:["#5eaab5","#2993a3"],whiteStylize:["#ffffff","#ffffff9f"],grayStylize:["#888888","#444444"]},M=n.WriteStream.prototype.hasColors(),L=(e,n)=>{if(!M)return e=>e;const i=`[${e}m`,t=`[${n}m`;return e=>{const n=`${e}`;let o=n.indexOf(t);if(-1===o)return i+n+t;let l=i,r=0;for(;-1!==o;)l+=n.slice(r,o)+i,r=o+t.length,o=n.indexOf(t,r);return l+=n.slice(r)+t,l}},S=(b=(e,n,i)=>L(`38;2;${e};${n};${i}`,39),e=>{const[n,i,t]=(e=>{let[,n]=/([\da-f]{3,6})/i.exec(e)||[];const i=n?n.length:0;if(3===i)n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2];else if(6!==i)return[0,0,0];const t=Number.parseInt(n,16);return[t>>16&255,t>>8&255,255&t]})(e);return b(n,i,t)}),$=L(...F.bold),z=L(...F.dim);S(F.blackStylize[0]),S(F.blackStylize[1]);var P=S(F.redStylize[0]);S(F.redStylize[1]);var N=S(F.greenStylize[0]);S(F.greenStylize[1]);var E=S(F.yellowStylize[0]);S(F.yellowStylize[1]),S(F.blueStylize[0]),S(F.blueStylize[1]);var A=S(F.magentaStylize[0]);S(F.magentaStylize[1]);var q=S(F.pinkStylize[0]);S(F.pinkStylize[1]);var I=S(F.cyanStylize[0]);S(F.cyanStylize[1]),S(F.whiteStylize[0]);var B=S(F.whiteStylize[1]),D=S(F.grayStylize[0]);S(F.grayStylize[1]);var V=e=>{let n="";const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<e;t+=1)n+=i.charAt(Math.floor(62*Math.random()));return n},O=h.default.promisify(o.exec),R=new a.Axiom({token:"xaat-137e6732-9a45-48d9-b12c-964c9fa88ed3"}),J={error:(...e)=>{T("error",...e)},info:(...e)=>{T("info",...e)},log:(...e)=>{T("log",...e)}},T=async(e,...n)=>{R.ingest("install",{level:e,machineId:"unknown",sessionId:"unknown",env:{appName:"unknown",appRoot:"unknown",language:"unknown",uriScheme:"unknown"},message:JSON.stringify(n)}),await R.flush()},W=R.flush,U=new i.PostHog("phc_dnFdhVY0JlEpyRhxewVBWgV7StMjHPFG7NbTPG26TNN",{host:"https://app.posthog.com",flushAt:1,flushInterval:0});function H({type:e="error",distinctId:n=`r-${V(10)}`,event:i,message:t,properties:o={},needAbort:l}){if(l)return function({title:e,message:n,status:i}){n?(y.note(n,P(e||"Error")),J.error(`${e}: ${n}`)):J.error(e);y.outro(`${P("Setup failed.")} Continue via ${I("http://million.dev/docs#manual-installation")}`),U.capture({distinctId:`r-${V(10)}`,event:"wizard-abort",properties:{body:{title:e,message:n}}}),G().then((()=>process.exit(i??1)))}({title:i,message:t});t?(y.note(t,i),J[e](`${i}: ${t}`,JSON.stringify(o))):J[e](i,JSON.stringify(o)),U.capture({distinctId:n,event:i,properties:o})}var G=async()=>{try{return await W(),U.shutdownAsync()}catch{process.exit(1)}};async function _(e,n){const i=await e;if(!y.isCancel(i))return e;H({event:"wizard-cancel",properties:{body:i}}),n&&await n(),y.cancel("Million Lint setup cancelled."),await G(),process.exit(1)}async function Y(e){const n=await async function(e){let n;try{n=await C.default.readFile(x.default.join(e,"package.json"),"utf8")}catch{return void H({event:"wizard-package-json-not-found",message:"Could not find package.json. Make sure to run the wizard in the root of your app!"})}return n}(e);if(!n)return;let i;try{i=JSON.parse(n)}catch{return H({event:"wizard-package-json-parse-error",message:"Unable to parse your package.json. Make sure it has a valid format!",needAbort:!0})}return{packageJson:i,packageJsonContents:n}}async function Z(e,n="@million/lint"){const i=await Y(e),t=i?.packageJson;return!!t?.dependencies?.[n]}var K={name:"yarn",label:"yarn",lockFile:"yarn.lock",installCommand:"yarn add",dlxCommand:"npx"},Q={name:"pnpm",label:"pnpm",lockFile:"pnpm-lock.yaml",installCommand:"pnpm install",dlxCommand:"pnpx"},X={name:"npm",label:"npm",lockFile:"package-lock.json",installCommand:"npm install",dlxCommand:"npx"},ee={name:"bun",label:"bun",lockFile:"bun.lockb",installCommand:"bun add",dlxCommand:"bunx"},ne=[Q,K,ee,X],ie={name:"craco",label:"Create React App",bundler:"webpack",prefix:"MillionLint.craco",configFilePath:"craco.config.js",possibleFileNames:["craco.config.js","craco.config.mjs","craco.config.cjs","craco.config.ts"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  webpack: {\n    plugins: { add: [million.webpack({ auto: true })] }\n  }\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: { add: [MillionLint.webpack({ legacyHmr: true })] }\n  }\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: {\n      add: [\n        million.webpack({ auto: true }),\n        MillionLint.webpack({ legacyHmr: true }),\n      ]\n    }\n  }\n};"}},te=[{name:"next",label:"Next.js",bundler:"next",prefix:"MillionLint.next",configFilePath:"next.config.mjs",possibleFileNames:["next.config.js","next.config.mjs"],million:{configFileContent:"import million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(nextConfig, millionConfig);",configFileContentRSC:"import million from 'million/compiler';\n    \n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: { rsc: true },\n};\n\nexport default million.next(nextConfig, millionConfig);"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next()(nextConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next({ rsc: true })(nextConfig);"},millionAndMillionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);"}},{name:"astro",label:"Astro",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"astro.config.mjs",possibleFileNames:["astro.config.js","astro.config.mjs","astro.config.cjs","astro.config.ts"],million:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\n\nexport default defineConfig({\n  vite: {\n    plugins: [million.vite({ mode: 'react', server: true, auto: true })]\n  }\n});"},millionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [MillionLint.vite()]\n  }\n});"},millionAndMillionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [\n      million.vite({ mode: 'react', server: true, auto: true }),\n      MillionLint.vite(),\n    ]\n  }\n});"}},{name:"gatsby",label:"Gatsby",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"gatsby-node.js",possibleFileNames:["gatsby-node.js","gatsby-node.ts"],otherPossibleFileNames:["gatsby-config.js","gatsby-config.ts"],million:{configFileContent:"const million = require('million/compiler');\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [million.webpack({ mode: 'react', server: true, auto: true })],\n  })\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\n  \nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [MillionLint.webpack()],\n  })\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [\n      million.webpack({ mode: 'react', server: true, auto: true }),\n      MillionLint.webpack(),\n    ],\n  })\n};"}},{name:"vite",label:"Vite",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"vite.config.js",possibleFileNames:["vite.config.js","vite.config.mjs","vite.config.cjs","vite.config.ts"],million:{configFileContent:"import million from 'million/compiler';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [million.vite({ auto: true }), react()],\n});"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [MillionLint.vite(), react()],\n});"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [\n    million.vite({ auto: true }),\n    MillionLint.vite(),\n    react(),\n  ],\n});"}},ie,{name:"webpack",label:"Webpack",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"webpack.config.js",possibleFileNames:["webpack.config.js"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n  ],\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    MillionLint.webpack(),\n  ],\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n    MillionLint.webpack(),\n  ],\n};"}},{name:"rollup",label:"Rollup",bundler:"rollup",prefix:"MillionLint.rollup",configFilePath:"rollup.config.js",possibleFileNames:["rollup.config.js","rollup.config.mjs","rollup.config.cjs","rollup.config.ts"],million:{configFileContent:"import million from 'million/compiler';\n\nexport default {\n  plugins: [million.rollup({ auto: true })],\n};"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\nexport default {\n  plugins: [MillionLint.rollup()],\n};"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default {\n  plugins: [\n    million.rollup({ auto: true }),\n    MillionLint.rollup(),\n  ],\n};"}}];async function oe({packageManager:e,packageName:n,flags:i=[],cwd:t}){"yarn"!==e.name&&"pnpm"!==e.name||i.push("--ignore-workspace-root-check");const{stderr:o}=await O(`${e.installCommand} ${n}@latest ${i.join(" ")}`,{cwd:t});o&&await O(`${e.installCommand} ${n}@latest --legacy-peer-deps ${i.join(" ")}`,{cwd:t})}var le=null;async function re(e){if(le)return le;const n=await async function(e){const n=await f.detect({cwd:e});if(!n)return null;const[i]=n.split("@");switch(i){case"yarn":return K;case"pnpm":return Q;case"npm":return X;case"bun":return ee;default:return null}}(e),i=await _(y.select({message:"Please select your package manager.",options:ne.map((e=>({value:e,label:e.label,hint:`Be sure you have ${$(e.label)} installed.`}))),initialValue:n||void 0}));return le=i}async function ae({packageName:e,alreadyInstalled:n,askBeforeUpdating:i=!0,cwd:t,installVSCode:o=!0,packageManager:l}){if(n&&i){if(!await _(y.confirm({message:`The ${I($(e))} package is already installed. Do you want to update it to the latest version?`})))return}l=l||await re(t);const r=y.spinner();r.start(`${n?"Updating":"Installing"} ${I($(e))} with ${$(l.label)}.`);try{await oe({packageManager:l,packageName:e,cwd:t}),H({type:"info",event:"wizard-package-manager",properties:{body:JSON.stringify(l)}}),r.stop(`${n?"Updated":"Installed"} ${I($(e))} with ${$(l.label)}.`)}catch(e){H({event:"wizard-failed-install",properties:{body:e.message}});const n="npm"===l.name&&e.message.includes("npm ERR"),i="yarn"===l.name&&e.message.includes("error "),t="pnpm"===l.name&&e.message.includes("ERR_"),o="bun"===l.name&&e.message.includes("error: "),a=n||i||t||o?"Error":"Warnings";y.log.error(P(`${a} during installation. ${e.message}`)),r.stop();if(!await _(y.confirm({message:"Would you like to continue anyway?"})))return H({event:"wizard-abort",properties:{body:e.message},needAbort:!0})}if(o){const e=y.spinner();try{e.start("Installing VSCode extension.");const i=await async function(){const{stdout:e}=await O("code --install-extension million.million-lint --force");return e.includes("already installed")?"VSCode extension already installed.":e.includes("not found")?"Code CLI not found. Try installing the extension manually. Search for 'million lint' in the extensions marketplace.":null}();H({type:"info",event:"wizard-vscode-install",properties:{body:JSON.stringify(i)}}),i?e.stop(i):e.stop((n?"Updated":"Installed")+" VSCode extension.")}catch(n){H({event:"wizard-vscode-failed-install"}),y.log.error(P("Could not install VSCode extension. Look up 'million-lint' in the extensions marketplace to install manually.")),e.stop();if(!await _(y.confirm({message:"Would you like to continue anyway?"})))return H({event:"wizard-abort",message:"VSCode extension installation failed.",properties:{body:n.message},needAbort:!0})}}}function se(e){return!!e&&!!e.includes("react-scripts start")}async function ce(e,n,i){if(se(e)){let t=e;t=t.replace("react-scripts start","craco start"),t=t.replace("react-scripts build","craco build"),t=t.replace("react-scripts test","craco test");try{const e=await re(i);await w.promises.writeFile(x.default.join(i,"package.json"),t),n.includes("million")&&n.includes("@million/lint")?await w.promises.writeFile(x.default.join(i,"craco.config.js"),ie.millionAndMillionLint.configFileContent):n.includes("million")?await w.promises.writeFile(x.default.join(i,"craco.config.js"),ie.million.configFileContent):n.includes("@million/lint")&&await w.promises.writeFile(x.default.join(i,"craco.config.js"),ie.millionLint.configFileContent),await oe({packageManager:e,packageName:"@craco/craco",cwd:i,flags:["-D"]})}catch(e){y.log.error("Could not install craco. Please install it manually.")}}}var ue=new Set(["<",">","{","}","[","]"]),fe=new Set(["for","do","while","if","else","return","function","var","let","const","true","false","undefined","this","new","delete","typeof","in","instanceof","void","break","continue","switch","case","default","throw","try","catch","finally","debugger","with","yield","async","await","class","extends","super","import","export","from","static"]),pe=new Set(["+","-","*","/","%","=","!","&","|","^","~","!","?",":",".",",",";","'",'"',".","(",")","[","]","#","@","\\",...ue]),[de,me,ge,be,ye,we,he,ve,xe,ke,Ce]=["identifier","keyword","string","class","property","entity","jsxliterals","sign","comment","break","space"].map(((e,n)=>n));function je(e){return/^[^\S\r\n]+$/g.test(e)}function Fe(e){return pe.has(e)}function Me(e){return/^[\w_]+$/.test(e)||Le(e)}function Le(e){return/[^\u0000-\u007f]/.test(e)}function Se(e){return/^[a-zA-Z]$/.test(e)}function $e(e){return Se(e)||Le(e)}function ze(e){return $e(e[0])&&(1===e.length||Me(e.slice(1)))}function Pe(e){return"`"===e}function Ne(e){return'"'===e||"'"===e}function Ee(e){return"//"===(e=e.slice(0,2))||"/*"===e}function Ae(e){let n="",i=-1,t=[-1,""],o=[-2,""];const l=[];let r=!1,a=0,s=!1,c=0;const u=()=>r&&!s&&!a,f=()=>a&&!u(),p=()=>!a&&u()&&!s&&c>0;let d=null,m=0,g=0;const b=()=>null!==d,y=()=>g>m,w=()=>b()||y();function h(e){const n="\n"===e;if(f()){if(b())return ge;const[,n]=t;if(ze(e)&&("<"===n||"</"===n))return we}if(p())return he;if(b())return ge;if(fe.has(e))return"."===t[1]?de:me;if(n)return ke;if(je(e))return Ce;if(e.split("").every(Fe))return ve;if(function(e){const n=e[0];return Me(n)&&n===n.toUpperCase()||"null"===e}(e))return f()?de:be;if(ze(e)){const e="."===t[1]&&ze(o[1]);if(!w()&&!e)return de;if(e)return ye}return ge}const v=(e,r)=>{if(r&&(n=r),n){i=e||h(n);const r=[i,n];i!==Ce&&i!==ke&&(o=t,t=r),l.push(r)}n=""};for(let i=0;i<e.length;i++){const o=e[i],l=e[i-1],f=e[i+1],b=l+o,h=o+f;if(Ne(o)&&!p()){v(),"\\"!==l&&(d&&o===d?d=null:d||(d=o)),v(ge,o);continue}if(!y()&&"\\n"!==l&&Pe(o)){v(),v(ge,o),g++;continue}if(y()){if("\\n"!==l&&Pe(o)&&g>0){v(),g--,v(ge,o);continue}if("${"===h){m++,v(ge),v(ve,h),i++;continue}}if(g>0&&g===m&&"}"===o){v(),m--,v(ve,o);continue}if(u()&&"{"===o){v(),v(ve,o),s=!0;continue}if(r){if(!a&&"<"===o){v(),"/"===f?(a=2,n=h,i++):(a=1,n=o),v(ve);continue}if(a){if(">"===o&&!"/=".includes(l)){v(),1===a?(a=0,c++):(a=0,r=!1),v(ve,o);continue}if("/>"===h||"</"===h){"<"!==n&&"/"!==n&&v(),"/>"===h?a=0:c--,c||(r=!1),n=h,i++,v(ve);continue}if("<"===o){v(),n=o,v(ve);continue}if("-"===f&&!w()&&!p()&&n){v(ye,n+o+f),i+=1;continue}if("="===f&&!w()){const e=n?n+o:o;ze(e)&&(n=e,v(ye));continue}}}!a&&("<"===o&&$e(f)||"</"===h)&&(a="/"===f?2:1,"<"!==o||"/"!==f&&!Se(f)||(r=!0));const C=Ne(k=o)||Pe(k),j=y(),F=!r&&("/"===(x=h)[0]&&!Ee(x[0]+x[1])),M=p();if(C||j||Ne(d))n+=o;else if(F){v();const[l,r]=t;if(F&&-1!==l&&(l!==ve||")"===r)&&l!==xe){n=o,v();continue}const a=i++,s=()=>i>=e.length,c=()=>s()||"\n"===e[i];let u=!1;for(;!c();i++)if("/"===e[i]&&"\\"!==e[i-1]){for(u=!0;a!==i&&/^[a-z]$/.test(e[i+1])&&!c();)i++;break}a!==i&&u?(n=e.slice(a,i+1),v(ge)):(n=o,v(),i=a)}else if(Ee(h)){v();const t=i;if("/"===f)for(;i<e.length&&"\n"!==e[i];i++);else for(;i<e.length&&e[i-1]+e[i]!=="*/";i++);n=e.slice(t,i+1),v(xe)}else" "===o||"\n"===o?" "!==o||!je(n)&&n&&!M?(v(),n=o,v()):(n+=o,"<"===f&&v()):s&&"}"===o?(v(),n=o,v(),s=!1):M&&!ue.has(o)||(Me(o)===Me(n[n.length-1])||u())&&!pe.has(o)?n+=o:("</"===b&&(n=b),v(),"</"!==b&&(n=o),"</"===h||"/>"===h?(n=h,v(),i++):ue.has(o)&&v())}var x,k;return v(),l}function qe(e,n={showLineNumbers:!1}){const i=Ae(e),t=[];let o=1;const l=[];function r(e){t.push(function(e){const i=n.showLineNumbers?`${z(`${o}`.padEnd(2," "))} `:"";return o++,`${i}${e}`}(e.map((([e,n])=>{switch(e){case 0:case 4:return q(n);case 1:case 2:case 7:return D(n);case 3:return E(n);case 5:return A(n);case 6:return B(n);case 8:return z(n);default:return n}})).join("")))}for(const e of i){const[n,i]=e;if(9!==n)if(i.includes("\n")){const e=i.split("\n");for(let i=0;i<e.length;i++)l.push([n,e[i]]),i<e.length-1&&(r(l),l.length=0)}else l.push(e);else l.push([n,""]),r(l),l.length=0}return l.length>0&&r(l),t.join("\n")}async function Ie(e,n,i){let t;y.note(`found existing ${e.configFilePath} file.`,`Transforming ${I(e.configFilePath)}`);try{let o=await async function(e,n){const i=x.default.join(n,e.configFilePath);return await C.default.readFile(i,{encoding:"utf-8"})}(e,i);const l=o,r=x.default.join(i,e.configFilePath);o.includes("@million/lint")&&H({event:"wizard-already-configured",message:P(`@million/lint is already configured in ${e.configFilePath}.`),needAbort:!0});const a=y.spinner(),s=function(e){if(e.includes("module.exports =")||e.includes("exports."))return"cjs";if(e.includes("export default"))return"esm";return"unknown"}(o);if(H({event:"wizard-modify-config",properties:{body:{type:s,oldCode:l,filePath:r}}}),"unknown"===s)return H({event:"wizard-unknown-module-type",message:"Unknown module type. Aborting.",needAbort:!0});let c,u,f;o=("esm"===s?"import MillionLint from '@million/lint';\n":"const MillionLint = require('@million/lint');\n")+o,"next"===e.name&&(c=await async function(){return w.existsSync("pages")?"pages":w.existsSync("app")?"app":w.existsSync("src/pages")?"pages":w.existsSync("src/app")?"app":await _(y.select({message:"Will you use app Router or pages Router?",options:[{label:"App Router",value:"app"},{label:"Pages Router",value:"pages"}]}))}()),a.start(`Modifying config file ${I(e.configFilePath)}...`),n.includes("million")&&n.includes("@million/lint")?(u=e.millionAndMillionLint.configFileContent,f=e.millionAndMillionLint.configFileContentRSC):n.includes("million")?(u=e.million.configFileContent,f=e.million.configFileContentRSC):n.includes("@million/lint")&&(u=e.millionLint.configFileContent,f=e.millionLint.configFileContentRSC),t="app"===c?f:u;const d=await async function(e,n,i,t,o){const{name:l,bundler:r}=n;try{const n=(e,n,i)=>{const t=n(e),a=j.callExpression(j.memberExpression(j.identifier("MillionLint"),j.identifier(r)),"craco"===l?[j.objectExpression([j.objectProperty(j.identifier("legacyHmr"),j.booleanLiteral(!0))])]:o?[j.objectExpression([j.objectProperty(j.identifier("rsc"),j.booleanLiteral(!0))])]:[]);if("next"===l){if(j.isClassDeclaration(t)||j.isFunctionDeclaration(t)||j.isTSDeclareFunction(t))return;i(j.callExpression(a,[t]))}if("vite"===l||"webpack"===l||"rollup"===l||"esbuild"===l||"rspack"===l||"craco"===l||"gatsby"===l||"astro"===l){let n=!1;if(e.traverse({ObjectProperty(i){if("craco"===l){if(j.isIdentifier(i.node.key)&&"plugins"===i.node.key.name&&!j.isPattern(i.node.value)&&!j.isRestElement(i.node.value)&&!j.isIdentifier(i.node.value)){let t;n=!0,t=j.isObjectExpression(i.node.value)&&i.node.value.properties.some((e=>j.isObjectProperty(e)&&j.isIdentifier(e.key)&&"add"===e.key.name))?i.node.value.properties.find((e=>j.isObjectProperty(e)&&j.isIdentifier(e.key)&&"add"===e.key.name)):j.objectProperty(j.identifier("add"),j.arrayExpression([a])),e.insertBefore([j.variableDeclaration("const",[j.variableDeclarator(j.identifier("plugins"),t.value)]),j.callExpression(j.memberExpression(j.identifier("plugins"),j.identifier("unshift")),[a])]),j.isObjectExpression(i.node.value)&&(i.node.value.properties=i.node.value.properties.filter((e=>!(j.isObjectProperty(e)&&j.isIdentifier(e.key)&&"add"===e.key.name))),i.node.value.properties.push(j.objectProperty(j.identifier("add"),j.identifier("plugins"))))}}else!j.isIdentifier(i.node.key)||"plugins"!==i.node.key.name||j.isPattern(i.node.value)||j.isRestElement(i.node.value)||j.isIdentifier(i.node.value)||(n=!0,e.insertBefore([j.variableDeclaration("const",[j.variableDeclarator(j.identifier("plugins"),i.node.value)]),j.callExpression(j.memberExpression(j.identifier("plugins"),j.identifier("unshift")),[a])]),i.node.value=j.identifier("plugins"))}}),!n){let n;const i=j.variableDeclaration("const",[j.variableDeclarator(j.identifier("plugins"),j.arrayExpression([a]))]),o=j.objectProperty(j.identifier("plugins"),j.identifier("plugins"));if(e.insertBefore([i]),"astro"===l){let e;t&&"CallExpression"===t.type&&j.isIdentifier(t.callee)&&"defineConfig"===t.callee.name&&(n=t.arguments[0]),n?.properties.length?e=n.properties.find((e=>!("ObjectProperty"!==e.type||!j.isIdentifier(e.key)||"vite"!==e.key.name||"ObjectExpression"!==e.value.type)))||j.objectProperty(j.identifier("vite"),j.objectExpression([o])):(e=j.objectProperty(j.identifier("vite"),j.objectExpression([o])),n=j.objectExpression([e])),t&&"CallExpression"===t.type&&j.isIdentifier(t.callee)&&"defineConfig"===t.callee.name&&(t.arguments[0]=n)}else"gatsby"===l?e.traverse({CallExpression(e){j.isMemberExpression(e.node.callee)&&j.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(n=e.node.arguments[0]),n?.properties.length?n.properties.push(o):n=j.objectExpression([o]),j.isMemberExpression(e.node.callee)&&j.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(e.node.arguments[0]=n)}}):"craco"===l&&j.isObjectExpression(t)&&t.properties.push(j.objectProperty(j.identifier("webpack"),j.objectExpression([j.objectProperty(j.identifier("add"),j.identifier("plugins"))])))}}},i=()=>({name:"wizard",visitor:{MemberExpression(e){const i=j.isIdentifier(e.node.object)&&"module"===e.node.object.name&&j.isIdentifier(e.node.property)&&"exports"===e.node.property.name,t=j.isIdentifier(e.node.object)&&"exports"===e.node.object.name;if(i||t){if(!j.isAssignmentExpression(e.parent))return;n(e.parentPath,(e=>e.node.right),(n=>{e.node.right=n}))}},ExportDefaultDeclaration(e){n(e,(e=>e.node.declaration),(n=>{e.node.declaration=n}))}}}),t=await p.transformAsync(e,{plugins:[i()],parserOpts:{plugins:["jsx","typescript"]}});return t?(H({type:"info",event:"wizard-success-modify-config",properties:{body:JSON.stringify(t)}}),t.code):null}catch(e){return H({event:"wizard-failed-get-new-file-content",message:`Unable to modify config file.\n\nHere is an installation reference:\n\n${t}`,properties:{body:e.message},needAbort:!0}),null}}(o,e,0,t,"app"===c);if(!d)return H({event:"wizard-no-changes-made",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,needAbort:!0});await C.default.writeFile(r,d,{encoding:"utf-8",flag:"w"}),a.stop(`Modified config file ${I(e.configFilePath)}.`),function(e,n,i,t=1){const o=v.diffWords(e,n);let l="";o.forEach(((e,n)=>{const i=n>0&&(o[n-1]?.added||o[n-1]?.removed),r=n<o.length-1&&(o[n+1]?.added||o[n+1]?.removed);let a="";if(e.added)a=N($(e.value));else if(e.removed)a=P(e.value);else if(i&&r){const n=e.value.split("\n");a=n.length-1>2*t?[n.slice(0,t).join("\n"),"...",n.slice(-t-1).join("\n")].join("\n"):z(e.value)}else i?a=e.value.split("\n").slice(0,t+1).join("\n"):r&&(a=e.value.split("\n").slice(-t-1).join("\n"));l+=a})),y.note(l,`Take a look at changes in ${I(i.configFilePath)}`)}(l,d,e);const m=async()=>{await C.default.writeFile(r,l,{encoding:"utf-8",flag:"w"}),H({event:"wizard-reverted-changes",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,needAbort:!0})};await _(y.confirm({message:"Does the config file look good?",initialValue:!0}),m)||await m()}catch(e){return H({event:"wizard-failed-modify-config",message:`Failed to modify config file.\n\nHere is an installation reference:\n\n${qe(t,{showLineNumbers:!0})}`,needAbort:!0})}}async function Be(){const e=x.default.join(k.default.cwd());await y.group({packageDotJson:async()=>await Y(e),selectPackages:async({results:e})=>{if(!e.packageDotJson)return;return await y.multiselect({message:"Please select the packages you want to install",options:[{value:"@million/lint",label:"Million Lint"},{value:"million",label:"Million.js"}],initialValues:["million","@million/lint"],required:!0})},buildTool:async({results:n})=>{if(!n.packageDotJson||!n.selectPackages?.length)return;const i=await async function({packageJsonContents:e,packages:n,cwd:i}){for(const t of te){if("craco"===t.name&&se(e)){if(y.log.success(`Detected ${$(ie.label)} project.`),!await _(await y.confirm({message:"Ordinary create-react-app projects are not supported. Do you want to use craco instead of react-scripts?"})))return void H({event:"wizard-craco-not-installed",message:"Please install craco manually: https://craco.js.org/docs/getting-started",needAbort:!0});{const t=y.spinner();t.start(`Installing ${$("craco")}...`),await ce(e,n,i),t.stop(`${$("craco")} installed.`)}return{buildTool:ie}}for(const e of t.possibleFileNames)if(w.existsSync(x.default.join(i,e))){const n={...t,configFilePath:e};return y.log.success(`Detected ${$(n.label)} project.`),{buildTool:n}}if("gatsby"===t.name)for(const e of t.otherPossibleFileNames)if(w.existsSync(x.default.join(i,e))){const e=t;return y.log.success(`Detected ${$(e.label)} project.`),n.includes("million")&&n.includes("@million/lint")?await w.promises.writeFile(x.default.join(i,t.configFilePath),t.millionAndMillionLint.configFileContent):n.includes("million")?await w.promises.writeFile(x.default.join(i,t.configFilePath),t.million.configFileContent):n.includes("@million/lint")&&await w.promises.writeFile(x.default.join(i,t.configFilePath),t.millionLint.configFileContent),{buildTool:e,skipUpdateConfigFile:!0}}}H({event:"wizard-no-build-tool-detected",message:`No build tool detected. No configuration file found in the current path: ${i}`,needAbort:!0})}({packageJsonContents:n.packageDotJson.packageJsonContents,packages:n.selectPackages,cwd:e}),{buildTool:t,skipUpdateConfigFile:o}=i||{};return{buildTool:t,skipUpdateConfigFile:o}},install:async({results:n})=>{if(n.packageDotJson&&n.buildTool&&n.selectPackages?.length)for(const i of n.selectPackages){const n=await Z(e,i);await ae({packageName:i,alreadyInstalled:n,cwd:e,installVSCode:"@million/lint"===i})}},updateConfigFile:async({results:n})=>{n.buildTool?.buildTool&&(n.buildTool?.skipUpdateConfigFile||n.selectPackages?.length&&await Ie(n.buildTool.buildTool,n.selectPackages,e))}},{onCancel:({results:e})=>{H({event:"wizard-cancel",properties:{body:e}}),y.cancel("Million Lint setup cancelled."),G().then((()=>k.default.exit(1)))}}),H({type:"info",event:"wizard-complete",properties:{body:!0}}),G().then((()=>k.default.exit(1)))}exports.beta=async function(e){try{y.intro(A(`âš¡ ${$("Million Lint beta")}`)),await async function(e){const n=x.default.join(process.cwd());await y.group({getVersions:async()=>{const n=y.spinner();try{let{npmVersion:i,vscodeVersion:t}=e.reduce(((e,n)=>{try{const[i,t]=n.split("=");return{...e,[i.split("--")[1]]:t}}catch{return e}}),{npmVersion:"",vscodeVersion:""});if(!i||!t){n.start("Fetching latest versions");let e="version.txt";i?e=`version-npm-${i}.txt`:t&&(e=`version-vscode-${t}.txt`);const o=await fetch(`https://beta-lint-r2.million.dev/${e}`).then((e=>e.text())).then((e=>{const[n,o]=e.split("\n");return{npm:i||n,vscode:t||o}}));i=o.npm,t=o.vscode,n.stop()}return y.note(`Downloading packages for NPM ${i} and VSCode ${t}`,"Get ready to install the packages."),{npmVersion:i,vscodeVersion:t}}catch(e){return n.stop(),H({event:"beta-error",message:"Failed to fetch versions",properties:{body:e.message}})}},fetchPackages:async({results:e})=>{if(!e.getVersions)return;const i=y.spinner();try{const{npmVersion:t,vscodeVersion:o}=e.getVersions;i.start("Downloading packages");const l=await fetch(`https://beta-lint-r2.million.dev/million-lint-${t}.tgz`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),r=x.default.join(n,`million-lint-${t}.tgz`);await C.default.writeFile(r,l);const a=await fetch(`https://beta-lint-r2.million.dev/million-lint-${o}.vsix`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),s=x.default.join(n,`million-lint-${o}.vsix`);await C.default.writeFile(s,a),i.message(`Downloaded packages: NPM ${t}, VSCode ${o}`);const c=await f.detect({programmatic:!0,cwd:n});if(!c)return H({event:"beta-error",message:"No package manager found",properties:{body:"No package manager found"}});const u=await f.parseNi(c,[r]);if(!u)return H({event:"beta-error",message:"Failed to create install command",properties:{body:"Failed to create install command"}});const{stderr:p}=await O(u);if(p)return H({event:"beta-error",message:"Failed to install packages",properties:{body:p}});const d=`code --install-extension ${s}`,{stderr:m}=await O(d);if(m)return H({event:"beta-error",message:"Failed to install packages",properties:{body:m}});await C.default.unlink(r),await C.default.unlink(s),i.stop()}catch(e){return i.stop(),H({event:"beta-error",message:"Failed to fetch packages",properties:{body:e.message}})}}},{onCancel:({results:e})=>{H({event:"beta-cancel",properties:{body:e}}),y.cancel("Million beta cancelled."),G().then((()=>process.exit(1)))}})}(e),y.outro(`${N($("âœ“ "))} You're all set! Enjoy! ðŸŽ‰`)}catch(e){H({event:"beta-error",properties:{body:e}})}},exports.install=async function(n,i="0.0.2"){try{e.intro(A(`âš¡ ${$(n)} ${z(i||"")}`)),await Be(),e.outro(`${N($("âœ“ "))} You're all set!`)}catch(e){H({event:"wizard-error",properties:{body:e}})}};