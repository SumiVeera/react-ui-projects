import*as e from"@clack/prompts";import{intro as n,outro as i}from"@clack/prompts";import{WriteStream as t}from"node:tty";import{PostHog as o}from"posthog-node";import*as l from"node:fs";import{exec as r}from"node:child_process";import a from"node:util";import*as s from"diff";import{Axiom as c}from"@axiomhq/js";import p from"node:path";import f from"node:process";import u from"node:fs/promises";import{detect as d,parseNi as m}from"@antfu/ni";import{transformAsync as g}from"@babel/core";import*as b from"@babel/types";var y,w={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgGray:[100,49],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49],blackStylize:["#121212","#eeeeee18"],redStylize:["#cb7676","#ab5959"],greenStylize:["#4d9375","#1e754f"],yellowStylize:["#f6c177","#f6c17790"],blueStylize:["#6394bf","#296aa3"],magentaStylize:["#c391e6","#c391e690"],pinkStylize:["#ed9cc2","#ed9cc290"],cyanStylize:["#5eaab5","#2993a3"],whiteStylize:["#ffffff","#ffffff9f"],grayStylize:["#888888","#444444"]},h=t.prototype.hasColors(),v=(e,n)=>{if(!h)return e=>e;const i=`[${e}m`,t=`[${n}m`;return e=>{const n=`${e}`;let o=n.indexOf(t);if(-1===o)return i+n+t;let l=i,r=0;for(;-1!==o;)l+=n.slice(r,o)+i,r=o+t.length,o=n.indexOf(t,r);return l+=n.slice(r)+t,l}},x=(y=(e,n,i)=>v(`38;2;${e};${n};${i}`,39),e=>{const[n,i,t]=(e=>{let[,n]=/([\da-f]{3,6})/i.exec(e)||[];const i=n?n.length:0;if(3===i)n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2];else if(6!==i)return[0,0,0];const t=Number.parseInt(n,16);return[t>>16&255,t>>8&255,255&t]})(e);return y(n,i,t)}),k=v(...w.bold),C=v(...w.dim);x(w.blackStylize[0]),x(w.blackStylize[1]);var j=x(w.redStylize[0]);x(w.redStylize[1]);var F=x(w.greenStylize[0]);x(w.greenStylize[1]);var M=x(w.yellowStylize[0]);x(w.yellowStylize[1]),x(w.blueStylize[0]),x(w.blueStylize[1]);var L=x(w.magentaStylize[0]);x(w.magentaStylize[1]);var S=x(w.pinkStylize[0]);x(w.pinkStylize[1]);var $=x(w.cyanStylize[0]);x(w.cyanStylize[1]),x(w.whiteStylize[0]);var z=x(w.whiteStylize[1]),P=x(w.grayStylize[0]);x(w.grayStylize[1]);var N=e=>{let n="";const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<e;t+=1)n+=i.charAt(Math.floor(62*Math.random()));return n},E=a.promisify(r),A=new c({token:"xaat-137e6732-9a45-48d9-b12c-964c9fa88ed3"}),I={error:(...e)=>{B("error",...e)},info:(...e)=>{B("info",...e)},log:(...e)=>{B("log",...e)}},B=async(e,...n)=>{A.ingest("install",{level:e,machineId:"unknown",sessionId:"unknown",env:{appName:"unknown",appRoot:"unknown",language:"unknown",uriScheme:"unknown"},message:JSON.stringify(n)}),await A.flush()},V=A.flush,D=new o("phc_dnFdhVY0JlEpyRhxewVBWgV7StMjHPFG7NbTPG26TNN",{host:"https://app.posthog.com",flushAt:1,flushInterval:0});function R({type:n="error",distinctId:i=`r-${N(10)}`,event:t,message:o,properties:l={},needAbort:r}){if(r)return function({title:n,message:i,status:t}){i?(e.note(i,j(n||"Error")),I.error(`${n}: ${i}`)):I.error(n);e.outro(`${j("Setup failed.")} Continue via ${$("http://million.dev/docs#manual-installation")}`),D.capture({distinctId:`r-${N(10)}`,event:"wizard-abort",properties:{body:{title:n,message:i}}}),O().then((()=>process.exit(t??1)))}({title:t,message:o});o?(e.note(o,t),I[n](`${t}: ${o}`,JSON.stringify(l))):I[n](t,JSON.stringify(l)),D.capture({distinctId:i,event:t,properties:l})}var O=async()=>{try{return await V(),D.shutdownAsync()}catch{process.exit(1)}};async function J(n,i){const t=await n;if(!e.isCancel(t))return n;R({event:"wizard-cancel",properties:{body:t}}),i&&await i(),e.cancel("Million Lint setup cancelled."),await O(),process.exit(1)}async function T(e){const n=await async function(e){let n;try{n=await u.readFile(p.join(e,"package.json"),"utf8")}catch{return void R({event:"wizard-package-json-not-found",message:"Could not find package.json. Make sure to run the wizard in the root of your app!"})}return n}(e);if(!n)return;let i;try{i=JSON.parse(n)}catch{return R({event:"wizard-package-json-parse-error",message:"Unable to parse your package.json. Make sure it has a valid format!",needAbort:!0})}return{packageJson:i,packageJsonContents:n}}async function W(e,n="@million/lint"){const i=await T(e),t=i?.packageJson;return!!t?.dependencies?.[n]}var q={name:"yarn",label:"yarn",lockFile:"yarn.lock",installCommand:"yarn add",dlxCommand:"npx"},U={name:"pnpm",label:"pnpm",lockFile:"pnpm-lock.yaml",installCommand:"pnpm install",dlxCommand:"pnpx"},H={name:"npm",label:"npm",lockFile:"package-lock.json",installCommand:"npm install",dlxCommand:"npx"},G={name:"bun",label:"bun",lockFile:"bun.lockb",installCommand:"bun add",dlxCommand:"bunx"},Y=[U,q,G,H],_={name:"craco",label:"Create React App",bundler:"webpack",prefix:"MillionLint.craco",configFilePath:"craco.config.js",possibleFileNames:["craco.config.js","craco.config.mjs","craco.config.cjs","craco.config.ts"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  webpack: {\n    plugins: { add: [million.webpack({ auto: true })] }\n  }\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: { add: [MillionLint.webpack({ legacyHmr: true })] }\n  }\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  webpack: {\n    plugins: {\n      add: [\n        million.webpack({ auto: true }),\n        MillionLint.webpack({ legacyHmr: true }),\n      ]\n    }\n  }\n};"}},Z=[{name:"next",label:"Next.js",bundler:"next",prefix:"MillionLint.next",configFilePath:"next.config.mjs",possibleFileNames:["next.config.js","next.config.mjs"],million:{configFileContent:"import million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(nextConfig, millionConfig);",configFileContentRSC:"import million from 'million/compiler';\n    \n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: { rsc: true },\n};\n\nexport default million.next(nextConfig, millionConfig);"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next()(nextConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next({ rsc: true })(nextConfig);"},millionAndMillionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\nimport million from 'million/compiler';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nconst millionConfig = {\n  auto: true,\n};\n\nexport default million.next(MillionLint.next({ rsc: true })(nextConfig), millionConfig);"}},{name:"astro",label:"Astro",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"astro.config.mjs",possibleFileNames:["astro.config.js","astro.config.mjs","astro.config.cjs","astro.config.ts"],million:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\n\nexport default defineConfig({\n  vite: {\n    plugins: [million.vite({ mode: 'react', server: true, auto: true })]\n  }\n});"},millionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [MillionLint.vite()]\n  }\n});"},millionAndMillionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  vite: {\n    plugins: [\n      million.vite({ mode: 'react', server: true, auto: true }),\n      MillionLint.vite(),\n    ]\n  }\n});"}},{name:"gatsby",label:"Gatsby",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"gatsby-node.js",possibleFileNames:["gatsby-node.js","gatsby-node.ts"],otherPossibleFileNames:["gatsby-config.js","gatsby-config.ts"],million:{configFileContent:"const million = require('million/compiler');\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [million.webpack({ mode: 'react', server: true, auto: true })],\n  })\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\n  \nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [MillionLint.webpack()],\n  })\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [\n      million.webpack({ mode: 'react', server: true, auto: true }),\n      MillionLint.webpack(),\n    ],\n  })\n};"}},{name:"vite",label:"Vite",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"vite.config.js",possibleFileNames:["vite.config.js","vite.config.mjs","vite.config.cjs","vite.config.ts"],million:{configFileContent:"import million from 'million/compiler';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [million.vite({ auto: true }), react()],\n});"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [MillionLint.vite(), react()],\n});"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [\n    million.vite({ auto: true }),\n    MillionLint.vite(),\n    react(),\n  ],\n});"}},_,{name:"webpack",label:"Webpack",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"webpack.config.js",possibleFileNames:["webpack.config.js"],million:{configFileContent:"const million = require('million/compiler');\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n  ],\n};"},millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    MillionLint.webpack(),\n  ],\n};"},millionAndMillionLint:{configFileContent:"const million = require('million/compiler');\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    million.webpack({ auto: true }),\n    MillionLint.webpack(),\n  ],\n};"}},{name:"rollup",label:"Rollup",bundler:"rollup",prefix:"MillionLint.rollup",configFilePath:"rollup.config.js",possibleFileNames:["rollup.config.js","rollup.config.mjs","rollup.config.cjs","rollup.config.ts"],million:{configFileContent:"import million from 'million/compiler';\n\nexport default {\n  plugins: [million.rollup({ auto: true })],\n};"},millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\nexport default {\n  plugins: [MillionLint.rollup()],\n};"},millionAndMillionLint:{configFileContent:"import million from 'million/compiler';\nimport MillionLint from '@million/lint';\n\nexport default {\n  plugins: [\n    million.rollup({ auto: true }),\n    MillionLint.rollup(),\n  ],\n};"}}];async function K({packageManager:e,packageName:n,flags:i=[],cwd:t}){"yarn"!==e.name&&"pnpm"!==e.name||i.push("--ignore-workspace-root-check");const{stderr:o}=await E(`${e.installCommand} ${n}@latest ${i.join(" ")}`,{cwd:t});o&&await E(`${e.installCommand} ${n}@latest --legacy-peer-deps ${i.join(" ")}`,{cwd:t})}var Q=null;async function X(n){if(Q)return Q;const i=await async function(e){const n=await d({cwd:e});if(!n)return null;const[i]=n.split("@");switch(i){case"yarn":return q;case"pnpm":return U;case"npm":return H;case"bun":return G;default:return null}}(n),t=await J(e.select({message:"Please select your package manager.",options:Y.map((e=>({value:e,label:e.label,hint:`Be sure you have ${k(e.label)} installed.`}))),initialValue:i||void 0}));return Q=t}async function ee({packageName:n,alreadyInstalled:i,askBeforeUpdating:t=!0,cwd:o,installVSCode:l=!0,packageManager:r}){if(i&&t){if(!await J(e.confirm({message:`The ${$(k(n))} package is already installed. Do you want to update it to the latest version?`})))return}r=r||await X(o);const a=e.spinner();a.start(`${i?"Updating":"Installing"} ${$(k(n))} with ${k(r.label)}.`);try{await K({packageManager:r,packageName:n,cwd:o}),R({type:"info",event:"wizard-package-manager",properties:{body:JSON.stringify(r)}}),a.stop(`${i?"Updated":"Installed"} ${$(k(n))} with ${k(r.label)}.`)}catch(n){R({event:"wizard-failed-install",properties:{body:n.message}});const i="npm"===r.name&&n.message.includes("npm ERR"),t="yarn"===r.name&&n.message.includes("error "),o="pnpm"===r.name&&n.message.includes("ERR_"),l="bun"===r.name&&n.message.includes("error: "),s=i||t||o||l?"Error":"Warnings";e.log.error(j(`${s} during installation. ${n.message}`)),a.stop();if(!await J(e.confirm({message:"Would you like to continue anyway?"})))return R({event:"wizard-abort",properties:{body:n.message},needAbort:!0})}if(l){const n=e.spinner();try{n.start("Installing VSCode extension.");const e=await async function(){const{stdout:e}=await E("code --install-extension million.million-lint --force");return e.includes("already installed")?"VSCode extension already installed.":e.includes("not found")?"Code CLI not found. Try installing the extension manually. Search for 'million lint' in the extensions marketplace.":null}();R({type:"info",event:"wizard-vscode-install",properties:{body:JSON.stringify(e)}}),e?n.stop(e):n.stop((i?"Updated":"Installed")+" VSCode extension.")}catch(i){R({event:"wizard-vscode-failed-install"}),e.log.error(j("Could not install VSCode extension. Look up 'million-lint' in the extensions marketplace to install manually.")),n.stop();if(!await J(e.confirm({message:"Would you like to continue anyway?"})))return R({event:"wizard-abort",message:"VSCode extension installation failed.",properties:{body:i.message},needAbort:!0})}}}function ne(e){return!!e&&!!e.includes("react-scripts start")}async function ie(n,i,t){if(ne(n)){let o=n;o=o.replace("react-scripts start","craco start"),o=o.replace("react-scripts build","craco build"),o=o.replace("react-scripts test","craco test");try{const e=await X(t);await l.promises.writeFile(p.join(t,"package.json"),o),i.includes("million")&&i.includes("@million/lint")?await l.promises.writeFile(p.join(t,"craco.config.js"),_.millionAndMillionLint.configFileContent):i.includes("million")?await l.promises.writeFile(p.join(t,"craco.config.js"),_.million.configFileContent):i.includes("@million/lint")&&await l.promises.writeFile(p.join(t,"craco.config.js"),_.millionLint.configFileContent),await K({packageManager:e,packageName:"@craco/craco",cwd:t,flags:["-D"]})}catch(n){e.log.error("Could not install craco. Please install it manually.")}}}var te=new Set(["<",">","{","}","[","]"]),oe=new Set(["for","do","while","if","else","return","function","var","let","const","true","false","undefined","this","new","delete","typeof","in","instanceof","void","break","continue","switch","case","default","throw","try","catch","finally","debugger","with","yield","async","await","class","extends","super","import","export","from","static"]),le=new Set(["+","-","*","/","%","=","!","&","|","^","~","!","?",":",".",",",";","'",'"',".","(",")","[","]","#","@","\\",...te]),[re,ae,se,ce,pe,fe,ue,de,me,ge,be]=["identifier","keyword","string","class","property","entity","jsxliterals","sign","comment","break","space"].map(((e,n)=>n));function ye(e){return/^[^\S\r\n]+$/g.test(e)}function we(e){return le.has(e)}function he(e){return/^[\w_]+$/.test(e)||ve(e)}function ve(e){return/[^\u0000-\u007f]/.test(e)}function xe(e){return/^[a-zA-Z]$/.test(e)}function ke(e){return xe(e)||ve(e)}function Ce(e){return ke(e[0])&&(1===e.length||he(e.slice(1)))}function je(e){return"`"===e}function Fe(e){return'"'===e||"'"===e}function Me(e){return"//"===(e=e.slice(0,2))||"/*"===e}function Le(e){let n="",i=-1,t=[-1,""],o=[-2,""];const l=[];let r=!1,a=0,s=!1,c=0;const p=()=>r&&!s&&!a,f=()=>a&&!p(),u=()=>!a&&p()&&!s&&c>0;let d=null,m=0,g=0;const b=()=>null!==d,y=()=>g>m,w=()=>b()||y();function h(e){const n="\n"===e;if(f()){if(b())return se;const[,n]=t;if(Ce(e)&&("<"===n||"</"===n))return fe}if(u())return ue;if(b())return se;if(oe.has(e))return"."===t[1]?re:ae;if(n)return ge;if(ye(e))return be;if(e.split("").every(we))return de;if(function(e){const n=e[0];return he(n)&&n===n.toUpperCase()||"null"===e}(e))return f()?re:ce;if(Ce(e)){const e="."===t[1]&&Ce(o[1]);if(!w()&&!e)return re;if(e)return pe}return se}const v=(e,r)=>{if(r&&(n=r),n){i=e||h(n);const r=[i,n];i!==be&&i!==ge&&(o=t,t=r),l.push(r)}n=""};for(let i=0;i<e.length;i++){const o=e[i],l=e[i-1],f=e[i+1],b=l+o,h=o+f;if(Fe(o)&&!u()){v(),"\\"!==l&&(d&&o===d?d=null:d||(d=o)),v(se,o);continue}if(!y()&&"\\n"!==l&&je(o)){v(),v(se,o),g++;continue}if(y()){if("\\n"!==l&&je(o)&&g>0){v(),g--,v(se,o);continue}if("${"===h){m++,v(se),v(de,h),i++;continue}}if(g>0&&g===m&&"}"===o){v(),m--,v(de,o);continue}if(p()&&"{"===o){v(),v(de,o),s=!0;continue}if(r){if(!a&&"<"===o){v(),"/"===f?(a=2,n=h,i++):(a=1,n=o),v(de);continue}if(a){if(">"===o&&!"/=".includes(l)){v(),1===a?(a=0,c++):(a=0,r=!1),v(de,o);continue}if("/>"===h||"</"===h){"<"!==n&&"/"!==n&&v(),"/>"===h?a=0:c--,c||(r=!1),n=h,i++,v(de);continue}if("<"===o){v(),n=o,v(de);continue}if("-"===f&&!w()&&!u()&&n){v(pe,n+o+f),i+=1;continue}if("="===f&&!w()){const e=n?n+o:o;Ce(e)&&(n=e,v(pe));continue}}}!a&&("<"===o&&ke(f)||"</"===h)&&(a="/"===f?2:1,"<"!==o||"/"!==f&&!xe(f)||(r=!0));const C=Fe(k=o)||je(k),j=y(),F=!r&&("/"===(x=h)[0]&&!Me(x[0]+x[1])),M=u();if(C||j||Fe(d))n+=o;else if(F){v();const[l,r]=t;if(F&&-1!==l&&(l!==de||")"===r)&&l!==me){n=o,v();continue}const a=i++,s=()=>i>=e.length,c=()=>s()||"\n"===e[i];let p=!1;for(;!c();i++)if("/"===e[i]&&"\\"!==e[i-1]){for(p=!0;a!==i&&/^[a-z]$/.test(e[i+1])&&!c();)i++;break}a!==i&&p?(n=e.slice(a,i+1),v(se)):(n=o,v(),i=a)}else if(Me(h)){v();const t=i;if("/"===f)for(;i<e.length&&"\n"!==e[i];i++);else for(;i<e.length&&e[i-1]+e[i]!=="*/";i++);n=e.slice(t,i+1),v(me)}else" "===o||"\n"===o?" "!==o||!ye(n)&&n&&!M?(v(),n=o,v()):(n+=o,"<"===f&&v()):s&&"}"===o?(v(),n=o,v(),s=!1):M&&!te.has(o)||(he(o)===he(n[n.length-1])||p())&&!le.has(o)?n+=o:("</"===b&&(n=b),v(),"</"!==b&&(n=o),"</"===h||"/>"===h?(n=h,v(),i++):te.has(o)&&v())}var x,k;return v(),l}function Se(e,n={showLineNumbers:!1}){const i=Le(e),t=[];let o=1;const l=[];function r(e){t.push(function(e){const i=n.showLineNumbers?`${C(`${o}`.padEnd(2," "))} `:"";return o++,`${i}${e}`}(e.map((([e,n])=>{switch(e){case 0:case 4:return S(n);case 1:case 2:case 7:return P(n);case 3:return M(n);case 5:return L(n);case 6:return z(n);case 8:return C(n);default:return n}})).join("")))}for(const e of i){const[n,i]=e;if(9!==n)if(i.includes("\n")){const e=i.split("\n");for(let i=0;i<e.length;i++)l.push([n,e[i]]),i<e.length-1&&(r(l),l.length=0)}else l.push(e);else l.push([n,""]),r(l),l.length=0}return l.length>0&&r(l),t.join("\n")}async function $e(n,i,t){let o;e.note(`found existing ${n.configFilePath} file.`,`Transforming ${$(n.configFilePath)}`);try{let r=await async function(e,n){const i=p.join(n,e.configFilePath);return await u.readFile(i,{encoding:"utf-8"})}(n,t);const a=r,c=p.join(t,n.configFilePath);r.includes("@million/lint")&&R({event:"wizard-already-configured",message:j(`@million/lint is already configured in ${n.configFilePath}.`),needAbort:!0});const f=e.spinner(),d=function(e){if(e.includes("module.exports =")||e.includes("exports."))return"cjs";if(e.includes("export default"))return"esm";return"unknown"}(r);if(R({event:"wizard-modify-config",properties:{body:{type:d,oldCode:a,filePath:c}}}),"unknown"===d)return R({event:"wizard-unknown-module-type",message:"Unknown module type. Aborting.",needAbort:!0});let m,y,w;r=("esm"===d?"import MillionLint from '@million/lint';\n":"const MillionLint = require('@million/lint');\n")+r,"next"===n.name&&(m=await async function(){return l.existsSync("pages")?"pages":l.existsSync("app")?"app":l.existsSync("src/pages")?"pages":l.existsSync("src/app")?"app":await J(e.select({message:"Will you use app Router or pages Router?",options:[{label:"App Router",value:"app"},{label:"Pages Router",value:"pages"}]}))}()),f.start(`Modifying config file ${$(n.configFilePath)}...`),i.includes("million")&&i.includes("@million/lint")?(y=n.millionAndMillionLint.configFileContent,w=n.millionAndMillionLint.configFileContentRSC):i.includes("million")?(y=n.million.configFileContent,w=n.million.configFileContentRSC):i.includes("@million/lint")&&(y=n.millionLint.configFileContent,w=n.millionLint.configFileContentRSC),o="app"===m?w:y;const h=await async function(e,n,i,t,o){const{name:l,bundler:r}=n;try{const n=(e,n,i)=>{const t=n(e),a=b.callExpression(b.memberExpression(b.identifier("MillionLint"),b.identifier(r)),"craco"===l?[b.objectExpression([b.objectProperty(b.identifier("legacyHmr"),b.booleanLiteral(!0))])]:o?[b.objectExpression([b.objectProperty(b.identifier("rsc"),b.booleanLiteral(!0))])]:[]);if("next"===l){if(b.isClassDeclaration(t)||b.isFunctionDeclaration(t)||b.isTSDeclareFunction(t))return;i(b.callExpression(a,[t]))}if("vite"===l||"webpack"===l||"rollup"===l||"esbuild"===l||"rspack"===l||"craco"===l||"gatsby"===l||"astro"===l){let n=!1;if(e.traverse({ObjectProperty(i){if("craco"===l){if(b.isIdentifier(i.node.key)&&"plugins"===i.node.key.name&&!b.isPattern(i.node.value)&&!b.isRestElement(i.node.value)&&!b.isIdentifier(i.node.value)){let t;n=!0,t=b.isObjectExpression(i.node.value)&&i.node.value.properties.some((e=>b.isObjectProperty(e)&&b.isIdentifier(e.key)&&"add"===e.key.name))?i.node.value.properties.find((e=>b.isObjectProperty(e)&&b.isIdentifier(e.key)&&"add"===e.key.name)):b.objectProperty(b.identifier("add"),b.arrayExpression([a])),e.insertBefore([b.variableDeclaration("const",[b.variableDeclarator(b.identifier("plugins"),t.value)]),b.callExpression(b.memberExpression(b.identifier("plugins"),b.identifier("unshift")),[a])]),b.isObjectExpression(i.node.value)&&(i.node.value.properties=i.node.value.properties.filter((e=>!(b.isObjectProperty(e)&&b.isIdentifier(e.key)&&"add"===e.key.name))),i.node.value.properties.push(b.objectProperty(b.identifier("add"),b.identifier("plugins"))))}}else!b.isIdentifier(i.node.key)||"plugins"!==i.node.key.name||b.isPattern(i.node.value)||b.isRestElement(i.node.value)||b.isIdentifier(i.node.value)||(n=!0,e.insertBefore([b.variableDeclaration("const",[b.variableDeclarator(b.identifier("plugins"),i.node.value)]),b.callExpression(b.memberExpression(b.identifier("plugins"),b.identifier("unshift")),[a])]),i.node.value=b.identifier("plugins"))}}),!n){let n;const i=b.variableDeclaration("const",[b.variableDeclarator(b.identifier("plugins"),b.arrayExpression([a]))]),o=b.objectProperty(b.identifier("plugins"),b.identifier("plugins"));if(e.insertBefore([i]),"astro"===l){let e;t&&"CallExpression"===t.type&&b.isIdentifier(t.callee)&&"defineConfig"===t.callee.name&&(n=t.arguments[0]),n?.properties.length?e=n.properties.find((e=>!("ObjectProperty"!==e.type||!b.isIdentifier(e.key)||"vite"!==e.key.name||"ObjectExpression"!==e.value.type)))||b.objectProperty(b.identifier("vite"),b.objectExpression([o])):(e=b.objectProperty(b.identifier("vite"),b.objectExpression([o])),n=b.objectExpression([e])),t&&"CallExpression"===t.type&&b.isIdentifier(t.callee)&&"defineConfig"===t.callee.name&&(t.arguments[0]=n)}else"gatsby"===l?e.traverse({CallExpression(e){b.isMemberExpression(e.node.callee)&&b.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(n=e.node.arguments[0]),n?.properties.length?n.properties.push(o):n=b.objectExpression([o]),b.isMemberExpression(e.node.callee)&&b.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(e.node.arguments[0]=n)}}):"craco"===l&&b.isObjectExpression(t)&&t.properties.push(b.objectProperty(b.identifier("webpack"),b.objectExpression([b.objectProperty(b.identifier("add"),b.identifier("plugins"))])))}}},i=()=>({name:"wizard",visitor:{MemberExpression(e){const i=b.isIdentifier(e.node.object)&&"module"===e.node.object.name&&b.isIdentifier(e.node.property)&&"exports"===e.node.property.name,t=b.isIdentifier(e.node.object)&&"exports"===e.node.object.name;if(i||t){if(!b.isAssignmentExpression(e.parent))return;n(e.parentPath,(e=>e.node.right),(n=>{e.node.right=n}))}},ExportDefaultDeclaration(e){n(e,(e=>e.node.declaration),(n=>{e.node.declaration=n}))}}}),t=await g(e,{plugins:[i()],parserOpts:{plugins:["jsx","typescript"]}});return t?(R({type:"info",event:"wizard-success-modify-config",properties:{body:JSON.stringify(t)}}),t.code):null}catch(e){return R({event:"wizard-failed-get-new-file-content",message:`Unable to modify config file.\n\nHere is an installation reference:\n\n${t}`,properties:{body:e.message},needAbort:!0}),null}}(r,n,0,o,"app"===m);if(!h)return R({event:"wizard-no-changes-made",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${Se(o,{showLineNumbers:!0})}`,needAbort:!0});await u.writeFile(c,h,{encoding:"utf-8",flag:"w"}),f.stop(`Modified config file ${$(n.configFilePath)}.`),function(n,i,t,o=1){const l=s.diffWords(n,i);let r="";l.forEach(((e,n)=>{const i=n>0&&(l[n-1]?.added||l[n-1]?.removed),t=n<l.length-1&&(l[n+1]?.added||l[n+1]?.removed);let a="";if(e.added)a=F(k(e.value));else if(e.removed)a=j(e.value);else if(i&&t){const n=e.value.split("\n");a=n.length-1>2*o?[n.slice(0,o).join("\n"),"...",n.slice(-o-1).join("\n")].join("\n"):C(e.value)}else i?a=e.value.split("\n").slice(0,o+1).join("\n"):t&&(a=e.value.split("\n").slice(-o-1).join("\n"));r+=a})),e.note(r,`Take a look at changes in ${$(t.configFilePath)}`)}(a,h,n);const v=async()=>{await u.writeFile(c,a,{encoding:"utf-8",flag:"w"}),R({event:"wizard-reverted-changes",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${Se(o,{showLineNumbers:!0})}`,needAbort:!0})};await J(e.confirm({message:"Does the config file look good?",initialValue:!0}),v)||await v()}catch(e){return R({event:"wizard-failed-modify-config",message:`Failed to modify config file.\n\nHere is an installation reference:\n\n${Se(o,{showLineNumbers:!0})}`,needAbort:!0})}}async function ze(){const n=p.join(f.cwd());await e.group({packageDotJson:async()=>await T(n),selectPackages:async({results:n})=>{if(!n.packageDotJson)return;return await e.multiselect({message:"Please select the packages you want to install",options:[{value:"@million/lint",label:"Million Lint"},{value:"million",label:"Million.js"}],initialValues:["million","@million/lint"],required:!0})},buildTool:async({results:i})=>{if(!i.packageDotJson||!i.selectPackages?.length)return;const t=await async function({packageJsonContents:n,packages:i,cwd:t}){for(const o of Z){if("craco"===o.name&&ne(n)){if(e.log.success(`Detected ${k(_.label)} project.`),!await J(await e.confirm({message:"Ordinary create-react-app projects are not supported. Do you want to use craco instead of react-scripts?"})))return void R({event:"wizard-craco-not-installed",message:"Please install craco manually: https://craco.js.org/docs/getting-started",needAbort:!0});{const o=e.spinner();o.start(`Installing ${k("craco")}...`),await ie(n,i,t),o.stop(`${k("craco")} installed.`)}return{buildTool:_}}for(const n of o.possibleFileNames)if(l.existsSync(p.join(t,n))){const i={...o,configFilePath:n};return e.log.success(`Detected ${k(i.label)} project.`),{buildTool:i}}if("gatsby"===o.name)for(const n of o.otherPossibleFileNames)if(l.existsSync(p.join(t,n))){const n=o;return e.log.success(`Detected ${k(n.label)} project.`),i.includes("million")&&i.includes("@million/lint")?await l.promises.writeFile(p.join(t,o.configFilePath),o.millionAndMillionLint.configFileContent):i.includes("million")?await l.promises.writeFile(p.join(t,o.configFilePath),o.million.configFileContent):i.includes("@million/lint")&&await l.promises.writeFile(p.join(t,o.configFilePath),o.millionLint.configFileContent),{buildTool:n,skipUpdateConfigFile:!0}}}R({event:"wizard-no-build-tool-detected",message:`No build tool detected. No configuration file found in the current path: ${t}`,needAbort:!0})}({packageJsonContents:i.packageDotJson.packageJsonContents,packages:i.selectPackages,cwd:n}),{buildTool:o,skipUpdateConfigFile:r}=t||{};return{buildTool:o,skipUpdateConfigFile:r}},install:async({results:e})=>{if(e.packageDotJson&&e.buildTool&&e.selectPackages?.length)for(const i of e.selectPackages){const e=await W(n,i);await ee({packageName:i,alreadyInstalled:e,cwd:n,installVSCode:"@million/lint"===i})}},updateConfigFile:async({results:e})=>{e.buildTool?.buildTool&&(e.buildTool?.skipUpdateConfigFile||e.selectPackages?.length&&await $e(e.buildTool.buildTool,e.selectPackages,n))}},{onCancel:({results:n})=>{R({event:"wizard-cancel",properties:{body:n}}),e.cancel("Million Lint setup cancelled."),O().then((()=>f.exit(1)))}}),R({type:"info",event:"wizard-complete",properties:{body:!0}}),O().then((()=>f.exit(1)))}async function Pe(n){try{e.intro(L(`⚡ ${k("Million Lint beta")}`)),await async function(n){const i=p.join(process.cwd());await e.group({getVersions:async()=>{const i=e.spinner();try{let{npmVersion:t,vscodeVersion:o}=n.reduce(((e,n)=>{try{const[i,t]=n.split("=");return{...e,[i.split("--")[1]]:t}}catch{return e}}),{npmVersion:"",vscodeVersion:""});if(!t||!o){i.start("Fetching latest versions");let e="version.txt";t?e=`version-npm-${t}.txt`:o&&(e=`version-vscode-${o}.txt`);const n=await fetch(`https://beta-lint-r2.million.dev/${e}`).then((e=>e.text())).then((e=>{const[n,i]=e.split("\n");return{npm:t||n,vscode:o||i}}));t=n.npm,o=n.vscode,i.stop()}return e.note(`Downloading packages for NPM ${t} and VSCode ${o}`,"Get ready to install the packages."),{npmVersion:t,vscodeVersion:o}}catch(e){return i.stop(),R({event:"beta-error",message:"Failed to fetch versions",properties:{body:e.message}})}},fetchPackages:async({results:n})=>{if(!n.getVersions)return;const t=e.spinner();try{const{npmVersion:e,vscodeVersion:o}=n.getVersions;t.start("Downloading packages");const l=await fetch(`https://beta-lint-r2.million.dev/million-lint-${e}.tgz`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),r=p.join(i,`million-lint-${e}.tgz`);await u.writeFile(r,l);const a=await fetch(`https://beta-lint-r2.million.dev/million-lint-${o}.vsix`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),s=p.join(i,`million-lint-${o}.vsix`);await u.writeFile(s,a),t.message(`Downloaded packages: NPM ${e}, VSCode ${o}`);const c=await d({programmatic:!0,cwd:i});if(!c)return R({event:"beta-error",message:"No package manager found",properties:{body:"No package manager found"}});const f=await m(c,[r]);if(!f)return R({event:"beta-error",message:"Failed to create install command",properties:{body:"Failed to create install command"}});const{stderr:g}=await E(f);if(g)return R({event:"beta-error",message:"Failed to install packages",properties:{body:g}});const b=`code --install-extension ${s}`,{stderr:y}=await E(b);if(y)return R({event:"beta-error",message:"Failed to install packages",properties:{body:y}});await u.unlink(r),await u.unlink(s),t.stop()}catch(e){return t.stop(),R({event:"beta-error",message:"Failed to fetch packages",properties:{body:e.message}})}}},{onCancel:({results:n})=>{R({event:"beta-cancel",properties:{body:n}}),e.cancel("Million beta cancelled."),O().then((()=>process.exit(1)))}})}(n),e.outro(`${F(k("✓ "))} You're all set! Enjoy! 🎉`)}catch(e){R({event:"beta-error",properties:{body:e}})}}async function Ne(e,t="0.0.2"){try{n(L(`⚡ ${k(e)} ${C(t||"")}`)),await ze(),i(`${F(k("✓ "))} You're all set!`)}catch(e){R({event:"wizard-error",properties:{body:e}})}}export{Pe as beta,Ne as install};